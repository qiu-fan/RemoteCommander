<!DOCTYPE html>
<head>
  <link rel="stylesheet" href="styles/main.css">
  <style>
  .tree-node {
    font-family: 'Segoe UI', sans-serif;
    line-height: 1.6;
    margin: 2px 0;
  }

  .tree-icon {
    display: inline-block;
    width: 20px;
    cursor: pointer;
    transition: transform 0.2s;
    user-select: none;
  }

  .tree-icon.collapsed {
    transform: rotate(-90deg);
  }

  .tree-icon.loading {
    opacity: 0.5;
    cursor: progress;
  }

  .tree-name {
    padding: 2px 8px;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .tree-name:hover {
    background: rgba(0, 120, 212, 0.1);
  }

  .tree-children {
    transition: max-height 0.3s ease-out;
    max-height: 0;
    overflow: hidden; /* ç¡®ä¿éšè—æº¢å‡ºå†…å®¹ */
    padding-left: 20px; /* ä¿æŒç¼©è¿› */
  }

  .tree-children.expanded {
    max-height: 500vh;
    overflow: visible; /* å±•å¼€åå…è®¸æ»šåŠ¨ */
  }

  .loading-text {
    color: #666;
    font-size: 0.8em;
    padding-left: 24px;
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  .error-text {
    color: #dc3545;
    padding-left: 24px;
    font-size: 0.8em;
  }

  .modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    padding: 2rem;
    border-radius: 12px;
    display: none;
  }
  .menu-list {
    background: rgb(255 255 255 / 65%);
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
    border :1px solid #44444450;
    border-radius: 6px;
    padding: 8px 0;
  }
  .menu-item {
    padding: 8px 16px;
    border-radius: 12px;
    color: #444;
    cursor: pointer;
    transition: background 0.2s;
  }
  .menu-item:hover {
    background: rgba(165, 165, 165, 0.5);
    border-radius: 16px;
  }
  .menu-divider {
    margin: 6px 0;
    border-color: rgb(255 255 255 / 50%);
  }
  </style>
</head>
<body>
  <div id="tree"></div>
  <div id="contextMenu" class="modal" style="display:none; min-width:180px; background: rgba(0, 0, 0, 0);">
    <div class="menu-list">
      <div class="menu-item" data-action="open">æ‰“å¼€æ–‡ä»¶</div>
      <div class="menu-item" data-action="delete">åˆ é™¤</div>
      <div class="menu-item" data-action="rename">é‡å‘½å</div>
      <div class="menu-item" data-action="move">ç§»åŠ¨</div>
      <hr class="menu-divider">
      <div class="menu-item" data-action="upload">ä¸Šä¼ </div>
      <div class="menu-item" data-action="download">ä¸‹è½½</div>
    </div>
  </div>
  <div id="error-container" style="color:red; padding:10px; display:none;"></div>
  <div id="dialogModal" class="modal">
    <div class="modal-content">
        <h4 id="modalTitle"></h4>
        <p id="modalMessage"></p>
        <button onclick="document.getElementById('dialogModal').style.display = 'none';">å…³é—­</button>
    </div>
  </div>

  <script type="text/javascript" src="/eel.js"></script>
  <script type="module">
  let treeInstance; 
  class LazyTree {
    constructor(container) {
      this.container = container;
      treeInstance = this;
      this.init();
      this.loadRoots();
      this.bindMenuEvents();
    }

    normalizePath(path) {
      return path
        .replace(/\\+/g, '\\')    // åˆå¹¶è¿ç»­åæ–œæ 
        .replace(/([^\\])$/, '$1\\') // ç¡®ä¿ç›®å½•ä»¥åæ–œæ ç»“å°¾
        .replace(/\\$/g, '');     // æ–‡ä»¶è·¯å¾„å»é™¤æœ«å°¾åæ–œæ 
    }

    bindMenuEvents() {
      document.getElementById('contextMenu').addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        if (action) this.handleMenuClick(action);
      });
    }

    handleMenuClick(action) {
      console.log('Selected Path:', this.selectedItem.path); // æ·»åŠ è°ƒè¯•æ—¥å¿—
      if (!this.selectedItem) {
        console.warn('No selected item');
        return;
      }

      const item = this.selectedItem;
      switch(action) {
        case 'open':
          eel.send_open_file(item.path);
          break;
        case 'delete':
          if(confirm(`ç¡®è®¤åˆ é™¤ ${item.name}?`)) {
            eel.send_delete_file(item.path);
          }
          break;
        case 'rename':
          const newName = prompt('è¾“å…¥æ–°åç§°', item.name);
          if(newName) {
            eel.rename_file(item.path, newName);
          }
          break;
        case 'move':
          const targetPath = prompt('è¾“å…¥ç›®æ ‡è·¯å¾„');
          if(targetPath) {
            eel.move_file(item.path, targetPath);
          }
          break;
        case 'download':
          eel.download_file(item.path);
          break;
      }
    }

    async loadRoots() {
      try {
        const { children } = await eel.get_children('Root')();
        children.forEach(item => this.createNode(item, this.container));
      } catch (e) {
        this.showError('åŠ è½½æ ¹ç›®å½•å¤±è´¥'+e);
      }
    }

    showContextMenu(e, item) {
      const menu = document.getElementById('contextMenu');
      menu.style.display = 'block';
      menu.style.left = `${e.pageX}px`;
      menu.style.top = `${e.pageY}px`;
      
      // æ·»åŠ è·¯å¾„æ ¼å¼åŒ–
      item.path = item.path.replace(/(\\+)/g, '\\'); // ç»Ÿä¸€è·¯å¾„åˆ†éš”ç¬¦
      if (item.isDir && !item.path.endsWith('\\')) {
        item.path += '\\';
      }
      
      this.selectedItem = { ...item }; // åˆ›å»ºæ–°å¯¹è±¡é¿å…å¼•ç”¨é—®é¢˜
      
      // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
      const closeMenu = () => {
        menu.style.display = 'none';
        document.removeEventListener('click', closeMenu);
      };
      document.addEventListener('click', closeMenu);
    }

    createNode(item, parent) {
      const node = document.createElement('div');
      node.className = 'tree-node';
      node.dataset.path = item.path;

      const icon = document.createElement('span');
      icon.className = `tree-icon ${item.isDir ? 'folder' : 'file'}`;
      icon.innerHTML = item.isDir ? 'ğŸ“' : 'ğŸ“„';

      if (item.isDir && !item.path.endsWith('\\')) {
        item.path += '\\';
      }

      if (item.isDir) {
        icon.classList.add('has-children');
        icon.addEventListener('click', async (e) => {
          e.stopPropagation();
          await this.toggleChildren(node, item);
        });
      }

      // æ·»åŠ äº‹ä»¶ç›‘å¬
      node.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        this.showContextMenu(e, item);
      });

      const name = document.createElement('span');
      name.className = 'tree-name';
      name.textContent = item.name;
      name.addEventListener('click', () => this.handleItemClick(item));

      node.append(icon, name);
      parent.append(node);

      // æ·»åŠ åŒå‡»äº‹ä»¶
      let clickTimer;
      name.addEventListener('click', () => {
        clearTimeout(clickTimer);
        clickTimer = setTimeout(() => {
          if (item.isDir) {
            this.toggleChildren(node, item);
          } else {
            this.handleItemClick(item);
          }
        }, 300); // å•å‡»å»¶è¿Ÿ
      });

      name.addEventListener('dblclick', () => {
        clearTimeout(clickTimer);
        if (item.isDir) {
          this.toggleChildren(node, item);
        } else {
          eel.send_open_file(item.path);
        }
      });

      return node;
    }

    async toggleChildren(node, item) {
      const icon = node.querySelector('.tree-icon');
      const childrenContainer = node.querySelector('.tree-children');
      
      // ä¿®å¤è·¯å¾„å¤„ç†
      const safePath = this.normalizePath(item.path);
      // icon.classList.toggle('collapsed');
    
      if (childrenContainer) {
        const isExpanded = childrenContainer.classList.contains('expanded');
        
        // ç«‹å³åˆ‡æ¢ç±»åä»¥è§¦å‘åŠ¨ç”»
        childrenContainer.classList.toggle('expanded');
        // icon.classList.toggle('collapsed');
        
        // è®¾ç½®åŠ¨ç”»ç›®æ ‡å€¼
        requestAnimationFrame(() => {
          childrenContainer.style.maxHeight = isExpanded 
            ? '0'
            : `${childrenContainer.scrollHeight}px`;
        });
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      icon.classList.add('loading');
      
      try {
        const response = await eel.get_children(safePath)();
        
        if(response.error) {
          this.showError(response.error, node);
          return;
        }

        const validChildren = response.children.map(child => ({
          ...child,
          path: child.path ? child.path : `${safePath}\\${child.name}`
        }));
        
        this.renderChildren(node, validChildren);
        icon.classList.remove('loading');
        
      } catch (e) {
        this.showError(`åŠ è½½å¤±è´¥: ${e.message}`, node);
      } finally {
        icon.classList.remove('loading');
      }
    }

    renderChildren(parentNode, children) {
      const childrenDiv = document.createElement('div');
      childrenDiv.className = 'tree-children'; // åˆå§‹æ— expanded
      
      if (children.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'loading-files';
        empty.textContent = 'ç©ºç›®å½•';
        childrenDiv.append(empty);
      } else {
        children.forEach(child => this.createNode(child, childrenDiv));
      }
      
      requestAnimationFrame(() => {
        const fullHeight = childrenDiv.scrollHeight;
        childrenDiv.style.maxHeight = '0';
        
        // æ­£ç¡®ç»‘å®štransitionendäº‹ä»¶
        childrenDiv.addEventListener('transitionend', () => {
          if (childrenDiv.classList.contains('expanded')) {
            childrenDiv.style.maxHeight = 'none';
          }
        }, { once: true });

        requestAnimationFrame(() => {
          childrenDiv.classList.add('expanded');
          childrenDiv.style.maxHeight = `${fullHeight}px`;
        });
      });
      
      parentNode.append(childrenDiv);
    }

    showError(msg, parent) {
      const error = document.createElement('div');
      error.className = 'error-text';
      error.textContent = msg;
      (parent || this.container).append(error);
      setTimeout(() => error.remove(), 3000);
    }

    handleItemClick(item) {
      if (!item.isDir) {
        eel.preview_file(item.path);
      }
    }

    init() {
      this.container.classList.add('enhanced-tree');
    }
  }

  eel.expose(show_info);
  function show_info(title, message) {
    const modal = document.getElementById('dialogModal');
    modal.querySelector('#modalTitle').textContent = title;
    modal.querySelector('#modalMessage').textContent = message;
    modal.style.display = 'block';
  };

  function handleMenuClick(action) {
    const item = treeInstance.selectedItem;
    switch(action) {
      case 'open':
        eel.send_open_file(item.path);
        break;
      case 'delete':
        if(confirm(`ç¡®è®¤åˆ é™¤ ${item.name}?`)) {
          eel.send_delete_file(item.path);
        }
        break;
      case 'rename':
        const newName = prompt('è¾“å…¥æ–°åç§°', item.name);
        if(newName) {
          eel.rename_file(item.path, newName);
        }
        break;
      case 'move':
        const targetPath = prompt('è¾“å…¥ç›®æ ‡è·¯å¾„');
        if(targetPath) {
          eel.move_file(item.path, targetPath);
        }
        break;
      case 'download':
        eel.download_file(item.path);
        break;
    }
  }

  // åˆå§‹åŒ–æ ‘
  new LazyTree(document.getElementById('tree'));
  </script>
</body>